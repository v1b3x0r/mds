# MDS Core v6.0: Linguistics System - Implementation Progress

**Date:** 2025-10-25
**Status:** âœ… Phase 4 Complete (Hi-Introvert Integration)

---

## âœ… Completed (Phase 1)

### 1. TranscriptBuffer Class
**File:** `src/world/transcript.ts`

**Features:**
- âœ… Circular buffer (max 1000 utterances)
- âœ… Add utterances with metadata (speaker, text, emotion, timestamp)
- âœ… Query methods: `getRecent()`, `getSince()`, `getBySpeaker()`, `getConversation()`
- âœ… Export/import for save/load

**Interface:**
```typescript
interface Utterance {
  id: string
  speaker: string
  text: string
  listener?: string
  timestamp: number
  emotion: { valence: number, arousal: number }
}
```

---

### 2. WorldLexicon Class
**File:** `src/world/lexicon.ts`

**Features:**
- âœ… Term registry with usage tracking
- âœ… Automatic weight adjustment (used more â†’ weight increases)
- âœ… Decay system (unused terms fade away)
- âœ… Category detection (greeting, question, expression, etc.)
- âœ… Emotion context (average valence/arousal)
- âœ… Query methods: `getPopular()`, `getByCategory()`, `getRecent()`
- âœ… Statistics: `getStats()` for analytics
- âœ… Export/import JSON

**Interface:**
```typescript
interface LexiconEntry {
  term: string
  meaning: string
  origin: string          // Entity who first used it
  category?: string
  usageCount: number
  weight: number          // 0-1, decays if not used
  emotionContext?: { valence, arousal }
}
```

---

### 3. LinguisticCrystallizer Class
**File:** `src/world/crystallizer.ts`

**Features:**
- âœ… Runs every N ticks (configurable, default: 50)
- âœ… Local pattern detection (frequency-based, no LLM)
- âœ… Phrase normalization (trim, lowercase, whitespace collapse)
- âœ… Category detection using heuristics:
  - Greeting patterns (hi, hello, ã“ã‚“ã«ã¡ã¯, etc.)
  - Questions (?, why, what, how)
  - High arousal â†’ expression
  - Positive valence â†’ affirmation
  - Negative valence â†’ concern
- âœ… Minimum usage threshold (default: 3 times)
- âœ… Decay management (calls `lexicon.decay()` every tick)

**Algorithm:**
```
1. Collect all utterances since last analysis
2. Normalize text (trim, lowercase)
3. Count frequency of each phrase
4. Track speakers + emotion context
5. Filter phrases with usage â‰¥ threshold
6. Detect category using heuristics
7. Add to lexicon
```

---

### 4. Module Exports
**File:** `src/world/index.ts`

**Added:**
```typescript
export { TranscriptBuffer } from './transcript'
export type { Utterance } from './transcript'

export { WorldLexicon } from './lexicon'
export type { LexiconEntry } from './lexicon'

export { LinguisticCrystallizer } from './crystallizer'
export type { CrystallizerConfig } from './crystallizer'
```

---

## âœ… Completed (Phase 2)

### 5. World Class Integration
**File:** `src/world/world.ts` âœ…

**IMPORTANT: Existing LLM Infrastructure**

World already has:
- âœ… `LanguageGenerator` - LLM dialogue generation (Phase 6)
- âœ… `SemanticSimilarity` - Embeddings for essence comparison (Phase 6)
- âœ… `llm` config - Unified LLM configuration (v5.3)

**Integration Strategy:**
- **Linguistics is separate layer** - Transcript/Lexicon/Crystallizer
- **No LLM duplication** - Use existing `semanticSimilarity` for v6.1+
- **Optional enhancement** - Use existing `languageGenerator` for semantic extraction (v6.1+)

**Need to add:**
```typescript
class World {
  // v6.0: Linguistics fields (NEW)
  transcript?: TranscriptBuffer
  lexicon?: WorldLexicon
  private crystallizer?: LinguisticCrystallizer

  constructor(options: WorldOptions) {
    // ... existing initialization

    // v6.0: Initialize linguistics (if enabled)
    if (options.features?.linguistics || options.linguistics?.enabled) {
      this.initializeLinguistics(options)
    }
  }

  // v6.0: Initialize linguistics system
  private initializeLinguistics(options: WorldOptions): void {
    this.transcript = new TranscriptBuffer(options.linguistics?.maxTranscript ?? 1000)
    this.lexicon = new WorldLexicon()

    this.crystallizer = new LinguisticCrystallizer({
      enabled: true,
      analyzeEvery: options.linguistics?.analyzeEvery ?? 50,
      minUsage: options.linguistics?.minUsage ?? 3,
      minLength: options.linguistics?.minLength ?? 2,
      maxLength: options.linguistics?.maxLength ?? 100
    })
  }

  tick(dt: number) {
    // ... existing phases

    // Phase 6: Linguistics update (v6.0 - if enabled)
    if (this.options.features?.linguistics && this.crystallizer) {
      this.updateLinguistics()
    }
  }

  // v6.0: Linguistics update phase
  private updateLinguistics(): void {
    if (this.crystallizer && this.transcript && this.lexicon) {
      this.crystallizer.tick(this.transcript, this.lexicon)
    }
  }

  // v6.0: Record entity speech
  recordSpeech(speaker: Entity, text: string, listener?: Entity): void {
    if (!this.transcript) return

    this.transcript.add({
      id: this.generateUUID(),
      speaker: speaker.id,
      text,
      listener: listener?.id,
      timestamp: Date.now(),
      emotion: {
        valence: speaker.emotion?.valence ?? 0,
        arousal: speaker.emotion?.arousal ?? 0.5
      }
    })
  }
}
```

**Config:**
```typescript
interface WorldOptions {
  // ... existing options

  // v6.0: Linguistics configuration
  linguistics?: {
    enabled: boolean
    analyzeEvery?: number    // Ticks between analysis (default: 50)
    minUsage?: number        // Minimum occurrences (default: 3)
    minLength?: number       // Min phrase length (default: 2)
    maxLength?: number       // Max phrase length (default: 100)
  }
}
```

---

**Implemented:**
```typescript
// Added to WorldOptions
features?: {
  linguistics?: boolean  // Enable emergent linguistics (Phase 10 / v6.0)
}

linguistics?: {
  enabled?: boolean
  maxTranscript?: number    // Default: 1000
  analyzeEvery?: number     // Default: 50
  minUsage?: number         // Default: 3
  minLength?: number        // Default: 2
  maxLength?: number        // Default: 100
}

// Added to World class
transcript?: TranscriptBuffer
lexicon?: WorldLexicon
private crystallizer?: LinguisticCrystallizer

// New methods
recordSpeech(speaker: Entity, text: string, listener?: Entity): void
getLexiconStats(): ReturnType<WorldLexicon['getStats']> | undefined
getPopularTerms(minUsage: number = 5): LexiconEntry[]
getRecentUtterances(count: number = 10): Utterance[]

// Tick integration
private updateLinguistics(): void  // Called in tick() if enabled
```

**Activation:**
```typescript
const world = new World({
  features: { linguistics: true },
  linguistics: {
    analyzeEvery: 50,  // Analyze every 50 ticks
    minUsage: 3        // Term must appear 3 times
  }
})
```

---

## âœ… Completed (Phase 3)

### Phase 3: Build & Test âœ…
- âœ… Run `npm run build` (verify no TypeScript errors)
- âœ… Run `npm test` (verify existing tests pass)
- âœ… Write unit tests for linguistics system
  - **41 tests** for TranscriptBuffer, WorldLexicon, LinguisticCrystallizer
  - **26 tests** for World integration (recordSpeech, tick, stats API)
  - **Total: 67 new tests, 100% pass**

---

## âœ… Completed (Phase 4)

### Phase 4: hi-introvert Integration âœ…
- âœ… Update hi-introvert to use Core v6.0
- âœ… Enable linguistics in WorldSession
- âœ… Record all entity speech to transcript (4 locations)
- âœ… Display lexicon in UI (`/lexicon` command)
- âœ… Build verification (TypeScript + Bun)
- âœ… All tests pass (109/109)

**Files Modified:**
- `hi-introvert/src/session/WorldSession.ts` (+80 lines)
  - Enabled linguistics in constructor
  - Added `recordSpeech()` calls in 4 locations
  - Enhanced `getStatusSummary()` with linguistics stats
  - Created `getLinguisticsLexicon()` method
- `hi-introvert/src/App.tsx` (+14 lines)
  - Added `/lexicon` command
  - Updated help text

**Details:** See [V6.0-HI-INTROVERT-INTEGRATION.md](V6.0-HI-INTROVERT-INTEGRATION.md)

---

## ğŸ“‹ Remaining Tasks

### Phase 5: Live Testing (Next Session)
- [ ] Run hi-introvert
- [ ] Let entities talk autonomously
- [ ] Wait ~15 seconds (30 ticks)
- [ ] Verify terms crystallize
- [ ] Test `/lexicon` command
- [ ] Check category detection
- [ ] Verify emotion context

### Phase 6: 1-on-1 Conversation Mode (Future)
- [ ] Refactor hi-introvert to single entity conversation
- [ ] Entity initiates conversation (not user)
- [ ] Entity asks questions based on curiosity
- [ ] Entity remembers user responses
- [ ] Entity adapts speech based on learned terms

---

## ğŸ“Š Statistics

**Files Created:** 7
- `src/world/transcript.ts` (105 lines)
- `src/world/lexicon.ts` (190 lines)
- `src/world/crystallizer.ts` (220 lines)
- `src/world/index.ts` (updated exports)
- `tests/test-linguistics.mjs` (441 lines)
- `tests/test-world-linguistics.mjs` (290 lines)
- `docs/V6.0-HI-INTROVERT-INTEGRATION.md` (240 lines)

**Files Modified:** 5
- `src/world/world.ts` (+130 lines)
- `src/index.ts` (+15 lines, exports)
- `package.json` (updated test script)
- `hi-introvert/src/session/WorldSession.ts` (+80 lines)
- `hi-introvert/src/App.tsx` (+14 lines)

**Total New Code:** ~1,725 lines
- Core system: ~645 lines
- Tests: ~731 lines
- Exports: ~15 lines
- Hi-Introvert integration: ~94 lines
- Documentation: ~240 lines

**Dependencies:** Zero (all self-contained)
**Breaking Changes:** None (all additive)

**Build Results:**
- âœ… TypeScript: No errors
- âœ… Tests: **109/109 passed** (42 existing + 67 new)
  - World: 10/10 âœ“
  - Renderer: 12/12 âœ“
  - WorldFile: 12/12 âœ“
  - Heroblind: 8/8 âœ“
  - **Linguistics: 41/41 âœ“** (new)
  - **World Linguistics: 26/26 âœ“** (new)
- âš ï¸ Bundle size: 238.49 KB (+51.75 KB from v5.6)
  - Full: 186.74 KB â†’ 238.49 KB (+27.7%)
  - Lite: 120.42 KB â†’ 151.13 KB (+25.5%)
  - Validator: 17.25 KB (unchanged)

---

## ğŸ¯ Next Steps

**Immediate (Current Session):**
1. Test with hi-introvert
2. Verify pattern detection works
3. Check lexicon decay behavior

**Future (v6.1+):**
1. Add LLM semantic extraction (optional)
2. Add entity learning (`Entity.hear()`, `Entity.knows()`)
3. Add concept drift tracking
4. Add lexicon visualization

---

## ğŸ’¡ Key Design Decisions

### 1. Local-First Pattern Detection
**Decision:** Use frequency-based analysis (no LLM required)

**Rationale:**
- Works offline
- Fast (milliseconds)
- Zero cost
- Privacy-preserving

**LLM is optional enhancement, not requirement**

---

### 2. Circular Buffer
**Decision:** Keep only last 1000 utterances

**Rationale:**
- Memory-bounded
- Recent context more relevant
- Old conversations decay naturally

---

### 3. Decay System
**Decision:** Terms decay if not used for >10 seconds

**Rationale:**
- Natural forgetting
- Prevents lexicon bloat
- Mimics human memory
- Weight drops 1% per tick â†’ forgotten at weight <0.01

---

### 4. Category Detection
**Decision:** Use heuristics (not ML)

**Rationale:**
- Fast
- Interpretable
- No training needed
- Good enough for v6.0

**Categories:**
- `greeting` - hi, hello, ã“ã‚“ã«ã¡ã¯
- `question` - ?, why, what, how
- `expression` - high arousal
- `affirmation` - positive valence
- `concern` - negative valence
- `statement` - default

---

## ğŸ§ª Testing Strategy

### Unit Tests (To Write)
```typescript
// transcript.test.ts
describe('TranscriptBuffer', () => {
  it('maintains max size (circular buffer)')
  it('returns recent utterances')
  it('filters by speaker')
  it('filters by timestamp')
})

// lexicon.test.ts
describe('WorldLexicon', () => {
  it('adds new terms')
  it('increments usage on re-add')
  it('increases weight with usage')
  it('decays unused terms')
  it('forgets terms below weight threshold')
  it('returns popular terms')
})

// crystallizer.test.ts
describe('LinguisticCrystallizer', () => {
  it('runs every N ticks')
  it('detects frequent phrases')
  it('requires minimum usage threshold')
  it('normalizes text before comparison')
  it('detects categories correctly')
  it('calculates average emotion')
})
```

### Integration Test (hi-introvert)
```typescript
// Test scenario:
// 1. Spawn 3 entities
// 2. Have them greet each other
// 3. Check transcript has 3 utterances
// 4. Wait 50 ticks
// 5. Check lexicon has "hi" entry with usage â‰¥ 3
// 6. Verify category = "greeting"
```

---

## ğŸ¨ Conway 2025 Aesthetics

**How this relates to Conway's Game of Life:**

```
Conway:     Cells â†’ Rules â†’ Patterns Emerge
Linguistics: Entities speak â†’ Crystallizer â†’ Language emerges

Simple rules â†’ Complex behavior
```

**Visualization Ideas:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ WORLD LEXICON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Total Terms: 12                      â”‚
â”‚ Active Terms: 8                      â”‚
â”‚ Total Usage: 47                      â”‚
â”‚                                      â”‚
â”‚ Popular Terms:                       â”‚
â”‚  1. "sup lol"      (12Ã—) greeting   â”‚
â”‚  2. "ã‚ã€hi"        (8Ã—)  greeting   â”‚
â”‚  3. "555"          (7Ã—)  expression â”‚
â”‚  4. "..."          (6Ã—)  glitch     â”‚
â”‚                                      â”‚
â”‚ Recent:                              â”‚
â”‚  "brb" (2Ã—, 3s ago) â†’ crystallizing â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“– User Documentation (Draft)

### Enabling Linguistics

```typescript
import { World } from '@v1b3x0r/mds-core'

const world = new World({
  linguistics: {
    enabled: true,
    analyzeEvery: 50,    // Analyze every 50 ticks
    minUsage: 3,         // Term must appear 3 times
  }
})

// Record speech
const yuki = world.spawn(yukiMaterial, 100, 100)
const says = yuki.speak('greeting')
world.recordSpeech(yuki, says)

// After 50 ticks...
world.tick(1000)

// Check what world learned
const popular = world.lexicon.getPopular()
console.log(popular)
```

---

**Last Updated:** 2025-10-25
**Status:** âœ… **v6.0 Core + Hi-Introvert Complete!** Phase 1-4 implemented, tested, and integrated.

**Next Session:**
- Phase 5: Live testing with hi-introvert
- Verify pattern detection works with real conversations
- Optional: v6.0.1 bundle optimization
- Optional: v6.1 LLM semantic enhancement
